import org.gradle.internal.xml.XmlTransformer

plugins {
    id("org.jetbrains.gradle.plugin.idea-ext") version "1.1"
}

project('runenv') {

    ext {
        mcversion = '1.18.2'
        forgeversion = '40.1.31'
        // javaversion = 17 // Defaults to 17 already
        //mappings channel: 'parchment', version: '2022.03.13-1.18.2'
        // runArgs = [ ] // Arguments applied to all runs
        // runProps = [ name: value ] // Properties applied to all runs
    }

    repositories {
        // Repositories for additional runtime dependencies go here
    }
    afterEvaluate {
        dependencies {
            // This is where any additional runtime dependencies for your dev environment go
        }
    }

    tasks.register("genBuildAllIntellijRuns") {
        dependsOn("genIntellijRuns")
        group("forgegradle runs")
        doLast {
            rootProject.files(
                    ".idea/runConfigurations/runenv_runClient.xml",
                    ".idea/runConfigurations/runenv_runServer.xml"
            ).each { file ->
                if (file.exists()) {
                    var transformer = new XmlTransformer()
                    transformer.addAction { XmlProvider provider ->
                        println("Action")
                        provider.asNode()
                                .configuration
                                .method
                                .option
                                .each {
                                    if (it.@name == "Make") {
                                        it.@name = "MakeProject"
                                    }
                                }
                    }
                    file.withReader { reader ->
                        var text = reader.getText();
                        println(text)
                        file.withWriter { writer ->
                            transformer.transform(text, writer)
                        }
                    }
                }
            }
        }
    }
}